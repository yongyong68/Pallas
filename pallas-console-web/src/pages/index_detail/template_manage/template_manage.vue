<template>
    <div class="my-tab-content">
        <div class="template_content" v-loading="loading" element-loading-text="请稍等···">
            <div class="template_tree">
                <div v-show="isAllPrivilege">
                  <el-button type="primary" size="small" @click="addTemplate">新增模板</el-button>
                  <el-button type="primary" size="small" @click="exportTemplate">导出模板</el-button>
                  <el-button type="primary" size="small" @click="importTemplate">导入模板</el-button>
                </div>
                <div class="mrg-top-10">
                  <el-tree node-key="id" :data="treeData" :props="defaultProps" default-expand-all :expand-on-click-node="false" highlight-current @node-click="handleNodeClick"></el-tree>
                </div>
            </div>
            <div class="template-warning" v-if="!isEditable"><i class="el-icon-warning"></i>请选择模板</div>
            <div v-for="template in templateList" :key="template.templateName" class="template-body">
                <template-edit v-if="templateInfo.templateName === template.templateName" :clusters="clusters" :index-id="indexId" :index-name="indexName" :is-all-privilege="isAllPrivilege" :template-info="templateInfo" :macro-list="macroList" @close-delete="closeDelete" @close-edit="closeEdit"></template-edit>                    
            </div>
        </div>
    <div v-if="isTemplateAddVisible">
        <template-add-dialog :template-add-info="templateAddInfo" @close-dialog="closeDialog" @submit-close-dialog="submitCloseDialog"></template-add-dialog>
    </div>
    <div v-if="isTemplateImportVisible">
        <template-import-dialog :index-id="indexId" :template-import-title="templateImportTitle" :template-import-url="templateImportUrl" @close-dialog="closeImportDialog" @close-submit-dialog="closeSubmitImportDialog"></template-import-dialog>
    </div>
    <div v-if="isExprotTemplateVisible">
        <template-export-dialog :index-id="indexId" :template-list="templateList" @close-export-dialog="closeExportDialog"></template-export-dialog>
    </div>
    </div>
</template>

<script>
import '../../../components';
import TemplateAddDialog from './template_add_dialog/template_add_dialog';
import TemplateImportDialog from './template_import_dialog/template_import_dialog';
import TemplateEdit from './template_edit/template_edit';
import TemplateExportDialog from './template_export_dialog/template_export_dialog';

export default {
  data() {
    return {
      loading: false,
      indexId: this.$route.query.indexId,
      indexName: this.$route.query.indexName,
      isAllPrivilege: false,
      templateInfo: {},
      templateList: [],
      isEditable: false,
      isTemplateAddVisible: false,
      isTemplateImportVisible: false,
      templateImportTitle: '',
      templateImportUrl: '',
      isExprotTemplateVisible: false,
      tempList: [],
      macroList: [],
      treeData: [{
        id: 'temp',
        label: '模板',
        children: [],
      }, {
        id: 'macro',
        label: '宏',
        children: [],
      }],
      templateAddInfo: {
        indexId: '',
        templateName: '',
        type: '1',
        description: '',
      },
      defaultProps: {
        children: 'children',
        label: 'label',
      },
      clusters: [],
    };
  },
  methods: {
    exportTemplate() {
      this.isExprotTemplateVisible = true;
    },
    closeExportDialog() {
      this.isExprotTemplateVisible = false;
    },
    importTemplate() {
      this.isTemplateImportVisible = true;
      this.templateImportTitle = '导入模板';
      this.templateImportUrl = `/pallas/index_template/import.json?indexId=${this.indexId}`;
    },
    addTemplate() {
      this.isTemplateAddVisible = true;
      this.templateAddInfo.indexId = this.indexId;
    },
    handleNodeClick(data) {
      if (!data.children) {
        this.isEditable = true;
        this.templateInfo = data;
        this.templateInfo.content = data.content || '';
        this.templateInfo.params = data.params || '';
      }
    },
    closeDelete() {
      this.getTemplateList();
      this.isEditable = false;
    },
    closeEdit() {
      this.getTemplateList();
    },
    closeDialog() {
      this.isTemplateAddVisible = false;
    },
    closeImportDialog() {
      this.isTemplateImportVisible = false;
    },
    closeSubmitImportDialog() {
      this.isTemplateImportVisible = false;
      this.getTemplateList();
    },
    handleCallback(data) {
      this.templateList = data.list;
      this.isAllPrivilege = data.allPrivilege;
      const array = JSON.parse(JSON.stringify(data.list));
      const tempArr = [];
      const macroArr = [];
      array.forEach((element) => {
        if (element.newer && element.type === 1) {
          const approvedLabel = this.$createElement('span', null, [this.$createElement('b', { style: { color: 'red' } }, '新 '), this.$createElement('span', null, element.templateName)]);
          this.$set(element, 'label', approvedLabel);
        } else {
          this.$set(element, 'label', element.templateName);
        }
        if (element.type === 1) {
          tempArr.push(element);
        } else {
          macroArr.push(element);
        }
      });
      this.treeData[0].children = tempArr;
      this.treeData[1].children = macroArr;
      this.tempList = tempArr;
      this.macroList = macroArr;
    },
    getTemplateList() {
      this.loading = true;
      this.$http.get(`/index_template/list.json?indexId=${this.indexId}`).then((data) => {
        this.handleCallback(data);
      })
      .finally(() => {
        this.loading = false;
      });
    },
    submitCloseDialog(val) {
      this.isTemplateAddVisible = false;
      this.loading = true;
      this.$http.get(`/index_template/list.json?indexId=${this.indexId}`).then((data) => {
        this.handleCallback(data);
        this.isEditable = true;
        Object.keys(this.templateList).forEach((element, index) => {
          if (this.templateList[index].templateName === val) {
            this.templateInfo = this.templateList[index];
            this.templateInfo.content = data.content || '';
            this.templateInfo.params = data.params || '';
            this.templateInfo.resultContent = '';
          }
        });
      })
      .finally(() => {
        this.loading = false;
      });
    },
    getClusters() {
      this.loading = true;
      this.$http.post('/index/version/metadata.json', { indexId: this.indexId }).then((data) => {
        this.clusters = data.clusters;
      })
      .finally(() => {
        this.loading = false;
      });
    },
  },
  components: {
    'template-add-dialog': TemplateAddDialog,
    'template-import-dialog': TemplateImportDialog,
    'template-edit': TemplateEdit,
    'template-export-dialog': TemplateExportDialog,
  },
  created() {
    this.getTemplateList();
    this.getClusters();
  },
};

</script>

<style type="text/css">
.template_content {
  display: table;
  width: 100%;
}
.template_tree {
  padding-right: 30px;
  display: table-cell;
  width: 245px;
}
.template-warning {
  text-align: center;
  color: red;
  font-size: larger;
  font-weight: bolder;
  display: table-cell;
  vertical-align: middle;
}
.template-warning i {
  padding-right: 10px;
}
.template-body {
  display: table-cell;
}
</style>
